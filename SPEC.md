# Prism SPEC V2

## 账号系统设计

### 功能设计
- 注册（密码制）
  - ID 和 email 均唯一校验，用户输入
  - 密码 与 密码校验
  - 昵称、界面语言（中/英，缺省中）
  - 支持 email 验证码
- 登录（密码制）：支持 ID 或 email 登录
- 个人资料页：ID 和 email 之外都可修改
- 支持退出登录
- 支持登录失败限制（轻量风控）
- 支持忘记密码 / 重置密码
- 支持SSO，目前只支持 Google账号
- 发信账号为：llm_notebook@163.com

## 管理系统设计

### 总体设计
系统初始化时候加一个管理员账号，和用户账号系统共享，该账号不能被改成非管理员

### 账号管理设计
- 管理所有用户账号，修改所有可修改的状态，以及删除用户
- 避免关联的笔记等数据变成孤儿，用户删除为逻辑删除
  - 之前的用户 ID 和 email 被释放出来，可以被别人注册
  - 关联的笔记不可见，逻辑上被删除，且不可恢复
- 被删除的用户在管理系统里显示，但不能恢复（ID/email可能已被注册）

### 笔记管理设计
- 管理所有笔记，不可修改用户笔记内容，只可以 删除笔记 和 恢复被删除的笔记
- 支持按照状态、属性等查询过滤，包括逻辑删除状态
- 管理后台对失败笔记展示最近一次分析失败诊断，并支持基础筛选，便于快速排障

### 聚合管理设计
- 管理所有聚合信息源，添加/删除/删除恢复、启用/停用、手动刷新等
  - 聚合信息源删除为逻辑删除
- 聚合刷新用后台任务实现
- 聚合刷新任务支持失败可观测（MVP），并在管理后台支持失败定位与重试

## 学习笔记设计

### 功能设计
- 每条笔记绑定一个外部链接，不支持上传文件
  - 所有网站的外部链接都支持，部分网站暂不支持：
    - 视频网站：如 YouTube 等
    - 反抓取网站：如 微信公众号 等
    - 用户使用黑名单网站的时候提示出错
    - 黑名单网站列表放到一个配置文件里便于更新维护
  - 对URL做简单的归一化，在笔记中显示的URL是归一化之后的
  - 去重和跨内容关联统一使用归一化URL
- 对外部链接触发大模型内容分析
  - 获取或分析失败时，用户可看到失败提示，并支持手动重试
  - 系统记录最近一次失败诊断信息，用于管理后台排障
- 用户书写自己的学习心得
  - 提交后用户可以继续编辑
  - 标签不超过5个
- 支持公开分享（私有/公开，缺省公开）
  - 私有：仅本人可见和编辑
  - 公开：任何人可查看，只读
- 同一用户重复提交同一外部链接时，提示已存在并跳转到已有笔记
- 用户可以删除笔记
  - 系统里先做逻辑删除，对所有用户都不再可见
  - 暂时不做回收站功能

### 验收要点
- 创建笔记后会自动触发摘要分析，并可见状态流转
- 自动摘要可展示且不可被用户编辑
- 学习心得可反复编辑并保存
- 私有笔记不可被他人访问，公开笔记可被他人只读访问
- 失败场景有明确提示，并可手动重试

## 信息聚合设计

### 功能设计
- Prism 维护一组预设信息源网站，对其做自动信息聚合
  - 使用RSS/Atom协议
  - 网站列表放到一个配置文件里便于更新维护
  - 涵盖主要的AI博客网站，比如：
    - 英文：Google/OpenAI Research Blog
    - 中文：机器之心
- 每个信息源（网站级别）映射为一个虚拟创作者
  - 虚拟创作者可被用户关注/取消关注
  - 虚拟创作者支持启用/停用；停用后不再产生新条目且不参与推荐
- 每个聚合条目绑定一个外部链接，并归属到一个虚拟创作者
- 每个聚合条目都触发大模型内容分析
  - 只有分析`成功`的条目对普通用户可见
  - 获取或分析失败时，管理员可看到失败提示，并支持手动重试
- 聚合条目用于信息分发，形态上等同于“用户内容为空的学习笔记”
- 聚合条目同样可以被直接收藏/点赞，逻辑等同于学习笔记
  - 收藏/点赞互动计数 = 聚合条目自身互动 + 关联公开笔记互动，且对互动用户去重

### 验收要点
- 预设信息源可自动生成聚合条目，且每条都归属到对应虚拟创作者
- 聚合条目 AI 分析状态对管理员可见，并符合`待分析`->`分析中`->`成功/失败`的流转
- 聚合条目支持收藏/点赞，互动计数口径符合定义且结果可回溯

## 社交设计

### 功能设计
- 支持关注/取消关注创作者（其他用户，或者信息聚合源）
  - 不可关注自己
- 支持收藏/取消收藏，点赞/取消点赞公开笔记和聚合条目
- 当公开笔记转为私有或被删除时：
  - 不再出现在信息流中
  - 不再对外可见

### 验收要点
- 用户可关注/取消关注真实创作者和虚拟创作者，且不可关注自己
- 收藏/点赞与取消操作均幂等，可重复触发且状态一致
- 公开笔记转私有或删除后，内容从信息流移除且不可再被互动

## 信息流设计

### 功能设计
- 用户关注，或者未关注的创作者，都是推荐给用户信息流的来源
- V2 推荐系统采用规则型推荐，不做复杂推荐算法
  - 先按内容发布时间倒排，学习笔记的发布时间是学习心得字段最后更新时间
- 支持按关注、未关注筛选
- 支持标签筛选

### 验收要点
- 信息流默认按内容发布时间倒排展示
- 关注/未关注筛选可正确过滤来源创作者
- 标签筛选可生效，并与关注筛选组合使用
- 同一条内容在同一信息流结果集中不重复出现

## 内容分析设计

### 功能设计
- 给定一个链接，自动分析其内容
  - 分析状态包括：`待分析`、`分析中`、`成功`、`失败`
  - 失败支持手动重试
  - 记录分析结果、分析时间、模型版本
    - 分析结果为：标题，发布时间，摘要，标签（不超过5个）
    - 摘要分为短摘要和长摘要，分别用于显示在卡片和详情页里
      - 短摘要不超过100个汉字/200个英文字符；长摘要不超过300个汉字/600个英文字符
      - 长摘要缺失时用短摘要代替；短摘要缺失时用长摘要截断代替
      - 短摘要和长摘要都缺失时，摘要块不显示
    - 标签：
      - 格式类似hashtag，中英文都可以
    - 发布时间：
      - 如果是聚合内容，从上游的RSS/Atom获取（如果有）
      - 如果是非聚合内容，或者从RSS/Atom无法获取，尽量从内容或者URL中推断发布时间
    - 语言：
      - 对标题，摘要，标签都起作用
      - 非中文内容，同时生成中文翻译
      - 界面语言为中文时显示中文内容，否则显示原始内容
- 支持使用Jina Reader服务获取链接的内容，以便于大模型分析
  - 用一个全局开关控制使用Jina还是直接访问链接
  - 如果配置文件里设置了Jina Token，就使用Token，否则用匿名方式
- 大模型服务支持这几种风格的API接口：OpenAI，Gemini，Claude
- 有全局网络代理选项，用于获取链接内容和访问大模型服务

## 页面与交互设计

框架：Tailwind + shadcn/ui
风格：极简 SaaS 风

### 总体设计
页面顶部有一个全局导航条，分左中右三个区：
- 左：产品名（回到主页），搜索框（设计参见Medium）
- 中：笔记（学习笔记），广场（信息流），中区保持全局居中
- 右：写笔记（用个写作图标），通知信息（用个铃铛图标），账号

### 账号
- 首页右上角有一个账号入口按钮：
  - 未登录：`登录/注册`
  - 已登录：显示`昵称`(如有)或者`ID`
- 点击后：
  - 未登录：进入认证页（登录/注册双Tab）
  - 已登录：进入个人资料页
- 认证页中，登录Tab和注册Tab都展示 `Google 账号登录` 入口
- Google 首次登录且系统中无匹配账号时，进入补全页完成 `ID` 必填后再创建账号
- 登录/退出登录，导航条中这个账号入口按钮自动发生变化
- 普通用户登录成功后进入`广场`模块
- 管理员登录成功后进入`管理后台`模块

### 管理
- 管理系统的入口，显示名为`管理后台`
- 管理系统的多个功能模块以多Tab的方式呈现：
  - `用户`，`笔记`，`聚合源`，`聚合条目`

### 笔记
- 两个Tab：`我的`，`收藏`
- 列表里条目以卡片方式展示，最多两列
- 条目卡片展示来源标题，创作者，发布时间，标签，摘要，收藏/点赞计数
  - 点击标题进入详情页，标题最多两行
  - 鼠标在`创作者`上悬停时弹出profile卡片，并在profile卡片中可以加关注
  - 标签优先用户标签，若无则是自动标签
  - 摘要明确分开自动摘要和学习心得两部分，如果过长可以截断，每部分最多三行
    - 这两部分用背景色做区分，不用标签文案
    - 为空的时候该块不显示
  - 收藏的计数和动作合并在一起，用图标+计数展示，点赞也类似
  - 用标签文案`聚合`和`笔记`做明确区分，显示在列表卡片右下角，和收藏/点赞同一行
- 详情页展示完整信息
  - 展示布局尽量紧凑，字段内容尽量显示，但尽量不显示字段名称，参考条目卡片的设计风格
  - 标题统一为`详情`，用标签文案`聚合`和`笔记`做明确区分
  - 可返回到对应的来源Tab，按钮名字统一为`返回`
  - 收藏/点赞的计数和动作、加关注，都参考条目卡片的设计
- `我的`
  - 卡片还需展示：分析状态，可见性
  - 详情页增加一个`编辑`按钮，进入编辑界面
- `收藏`
  - 无特殊要求

### 广场
- 两个Tab：`已关注`，`未关注`
- 列表里条目以卡片方式展示，最多两列
- 卡片和详情页设计参照`笔记`中的`收藏`部分
- 支持标签筛选

### 搜索
- 用全局导航条的搜索入口做笔记和广场的搜索
- 笔记和广场页面不再留单独的搜索入口
- 笔记和广场列表页的Tag可以点击，动作是按该Tag过滤

## 附录与杂项

### git
- Conventional Commits，英文单行message
